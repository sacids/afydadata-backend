
{% load custom_tags %}

<ul class="h-8 w-full border-b flex space-x-4 px-5 mt-2 text-sm" x-data="{link:'data'}">
    <li
        class="flex hover:text-rose-800 cursor-pointer"     
        :class="{ 'border-b-2 border-rose-900': link == 'data' }"
        hx-get="{% url 'instance_data' id %}" hx-target="#sidebar-detail" hx-trigger="click" 
        @click="link = 'data'">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5" />
        </svg>
        <p class="pl-1">Data</p>
    </li>   

    <li   
        class="flex hover:text-rose-800 cursor-pointer"  
        :class="{ 'border-b-2 border-rose-900': link == 'chat' }"
        hx-get="{% url 'instance_messages' id %}" hx-target="#sidebar-detail" hx-trigger="click" 
        @click="link = 'chat'">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 01.778-.332 48.294 48.294 0 005.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
        </svg>
        <p class="pl-1">Messages</p>
    </li>  

    <li     
        class="flex hover:text-rose-800 cursor-pointer"  
        :class="{ 'border-b-2 border-rose-900': link == 'location' }"
        hx-get="{% url 'instance_location' id %}" hx-target="#sidebar-detail" hx-trigger="click" 
        @click="link = 'location'">
        
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
        </svg>
        <p class="pl-1">Location</p>   
    </li>   


    <li     
        class="flex hover:text-rose-800 cursor-pointer"  
        :class="{ 'border-b-2 border-rose-900': link == 'media' }"
        hx-get="{% url 'instance_media' id %}" hx-target="#sidebar-detail" hx-trigger="click" 
        @click="link = 'media'">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
        </svg>
        <p class="pl-1">Media</p> 
    </li>  
</ul>

<div class="h-[calc(100%-5rem)] overflow-y-scroll" id="sidebar-detail">
    
    <div class="pb-20 p-5">

    {% for group in data_questions %}
        {% for k,item in group.items %}
            <p class="text-md text-rose-800 "> {{k|make_title}} </p>
            <div class="text-sm pb-3">
            {% for v in item %}
                <div class="grid grid-cols-4 gap-4">
                    <p class="font-semibold"> {% if v.label == None %} {{ v.col_name|make_title}} {% else %} {{ v.label }}{% endif %}</p>
                    <p class="col-span-3"> {{ data_instance|get_value:v.col_name}}</p>
                </div>
            {% endfor %}
            </div>
        {% endfor %}

    {% endfor %}

    </div>

</div>

<script>

    htmx.process("#sidebar-detail")

    function manageMessages(){

        return{
  
           notes:            [], 
           note_uploading:   false,
           new_note:         "",
  
           fetchNotes(){
              this.notes = [
                 {% for note in notes %}
                       {
                          initials    : "{{ note.initials }}",
                          name        : "{{ note.name }}",
                          created_on  : "{{ note.created_on }}",
                          message     : "{{ note.message }}",
                       },
                 {% endfor %}
              ]
           },
  
           addNote(){
  
              console.log('adding note');
              this.note_uploading = true;
              var url             = "{% url 'instance_messages' id %}";
  
              let formData    = new FormData();
              formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
              formData.append("message", this.new_note);
  
              fetch(url, {
                    method: 'POST',
                    body: formData,
                    credentials : 'same-origin',
              })
              .then(res => res.json())
              .then(data => {
  
                 var tmp = {
                    'initials': '{{user.first_name|upper|make_list|first}}{{user.last_name|upper|make_list|first}}',
                    'name':     '{{user.first_name}} {{user.last_name}}',
                    'message':  this.new_note,
                    'created_on': 'Just now',
                 };
                 
                 this.notes.unshift(tmp);
                 this.new_note   = "";
                 this.note_uploading     = false;
              })
              .catch(() => {
                    console.log('upload error')
              })
              .finally(() => {
                    this.note_uploading     = false;
              })
  
           },
  
           init(){
              this.fetchNotes();
           },
  
        }
     }
</script>